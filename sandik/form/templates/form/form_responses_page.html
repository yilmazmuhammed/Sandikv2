{% extends "utils/layout.html" %}
{% block js_block %}
<script>
  jQuery(function($){
    let valid_status = {{ g.valid_status|safe }};

    FooTable.IsValidFilter = FooTable.Filtering.extend({
      construct: function(instance){
        this._super(instance);
        this.statuses = [valid_status["valid"], valid_status["multi_click"],valid_status["is_not_unique"],valid_status["not_created"],valid_status["deleted"]]; // the options available in the dropdown
        this.def = "Hepsi"; // the default/unselected value for the dropdown (this would clear the filter when selected)
        this.$status = null; // a placeholder for our jQuery wrapper around the dropdown
      },
      $create: function(){
        this._super(); // call the base $create method, this populates the $form property
        var self = this, // hold a reference to my self for use later
          // create the bootstrap form group and append it to the form
          $form_grp = $('<div/>', {'class': 'form-group'})
            .append($('<label/>', {'class': 'sr-only', text: 'Status'}))
            .prependTo(self.$form);

        // create the select element with the default value and append it to the form group
        self.$status = $('<select/>', { 'class': 'form-control' })
          .on('change', {self: self}, self._onStatusDropdownChanged)
          .append($('<option/>', {text: self.def}))
          .appendTo($form_grp);

        // add each of the statuses to the dropdown element
        $.each(self.statuses, function(i, status){
          self.$status.append($('<option/>').text(status));
        });
        self.addFilter('is_valid', valid_status["valid"], ['is_valid']);
        self.filter();
      },
      _onStatusDropdownChanged: function(e){
        var self = e.data.self, // get the MyFiltering object
          selected = $(this).val(); // get the current dropdown value
        if (selected !== self.def){ // if it's not the default value add a new filter
          self.addFilter('is_valid', selected, ['is_valid']);
        } else { // otherwise remove the filter
          self.removeFilter('is_valid');
        }
        // initiate the actual filter operation
        self.filter();
      },
      draw: function(){
        this._super(); // call the base draw method, this will handle the default search input
        var status = this.find('is_valid'); // find the status filter
        if (status instanceof FooTable.Filter){ // if it exists update the dropdown to reflect the value
          this.$status.val(status.query.val());
        } else { // otherwise update the dropdown to the default value
          this.$status.val(this.def);
        }
      }
    });

    $('#responses-table').footable({
      components: {
        filtering: FooTable.IsValidFilter
      },
      "toggleColumn": "first",
      "expandFirst": false,
      "paging": {
        "enabled": false,
      },
      "filtering": {
        "enabled": true,
        "delay": 1,
      "dropdownTitle": "Şu sütunlarda ara:"
      },
      "sorting": {
        "enabled": true
      },
      columns: {{ g.columns|safe }},
      rows: {{ g.rows|safe }},
    });

  });
</script>
{% endblock %}
{% block content_block %}
  <div class="bg-light lter b-b wrapper-md">
    <h1 class="m-n font-thin h3">{{ page_info.title }}</h1>
  </div>
  <div class="wrapper-md">
    <div class="panel panel-default">
      <div class="panel-heading">
        {{ page_info.title }}
        <span class="pull-right">
          <a href="{{ url_for("form_api_bp.download_form_responses_api", form_id=g.form.id, file_format="xlsx", only_valid=1) }}" class="btn btn-xs btn-primary">
            <i class="fa fa-file-excel-o"></i>
          </a>
          <a href="{{ url_for("form_api_bp.download_form_responses_api", form_id=g.form.id, file_format="csv", only_valid=1) }}" class="btn btn-xs btn-primary">
            <i class="fa fa-file-csv"></i>
          </a>
        </span>
      </div>
      <div class="table table-responsive">
        <table class="table" id="responses-table"></table>
      </div>
    </div>
  </div>
{% endblock %}