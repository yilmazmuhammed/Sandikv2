{% extends "utils/layout.html" %}
{% import "utils/parts/macros.html" as macros%}

{% block js_block %}
<script src="{{ url_for('static', filename='my_custom/js/footable_filters.js') }}"></script>
<script>
jQuery(function($){
	$('#all-payments-table').footable({
    components: {
      filtering: create_footable_basic_filter("is_fully_paid", "Ödenme durumu:", ["Ödenmedi", "Ödendi"], "Ödendi"),
    },
    "toggleColumn": "first",
    "paging": {
      "enabled": true,
      "size": 50
    },
    "filtering": {
      "enabled": true,
      "delay": 1,
      "dropdownTitle": "Şu sütunlarda ara:"
    },
    "sorting": {
      "enabled": true
    },
		"columns": [
			{ "name": "id", "title": "#", "breakpoints": "xs sm"},
			{ "name": "term", "title": "Dönem" },
			{ "name": "name_surname", "title": "İsim Soyisim" },
			{ "name": "transaction_type", "title": "İşlem türü", "breakpoints": "xs", },
			{ "name": "amount", "title": "Miktar", },
			{ "name": "remaining_amount", "title": "Ödenmemiş miktar", },
			{ "name": "is_fully_paid", "title": "Ödenme durumu", "breakpoints": "xs sm md", },
			{ "name": "detail", "title": "Detay", "breakpoints": "xs sm md", },
			{ "name": "sub_receipts", "title": "", "breakpoints": "xs sm md lg", },
			{ "name": "action", "title": "", "breakpoints": "xs sm md", },
		],
		"rows": [
    {% for p in g.payments %}
      {% if isinstance(p, Contribution) %}
        {% set id_prefix='c' %}
        {% set transaction_type='Aidat' %}
        {% set detail='' %}
      {% elif isinstance(p, Installment) %}
        {% set id_prefix='i' %}
        {% set transaction_type='Taksit' %}
        {% set detail='Borç: #'+p.debt_ref.id|string %}
      {% else %}
        {% set id_prefix='UNKNOWN' %}
        {% set transaction_type='UNKNOWN' %}
        {% set detail='' %}
      {% endif %}
      {
        "id": `<span title='ID: {{ id_prefix }}-{{ p.id }}'>{{ loop.revindex }}</span>`,
        "term": "{{ p.term }}",
        "name_surname": "{{ p.member_ref.web_user_ref.name_surname }} - {{ p.share_ref.share_order_of_member }}",
        "transaction_type": `{{ transaction_type }}`,
        "amount": "{{ p.amount }} ₺",
        "remaining_amount": `<span class="{% if p.is_fully_paid %}text-success{% else %}text-danger{% endif %}">{{ p.get_unpaid_amount() }} ₺</span>`,
        "is_fully_paid": `{% if p.is_fully_paid %}<span class="text-success">Ödendi</span>{% elif p.get_paid_amount()>0 %}<span class="text-danger">Eksik</span>{% else %}<span class="text-danger">Ödenmedi</span>{% endif %}`,
        "sub_receipts": `
          {% if p.sub_receipts_set.count() == 0 %}
          İşlem yok
          {% else %}
            <div class="table table-responsive">
              <table class="table table-striped table-bordered" id="sub-receipts-of-{{ id_prefix }}{{ p.id }}-table">
                <tr>
                  <th colspan=2 class='text-center'>Para girişi</th>
                  <th colspan=3 class='text-center'>İlişkilendirme</th>
                </tr>
                <tr>
                  <th>Tarih</th>
                  <th>Miktar</th>
                  <th>Tarih</th>
                  <th>Miktar</th>
                  <th>Kalan Miktar</th>
                </tr>
                {% set sr_amounts = [] %}
                {% for sr in p.sub_receipts_set.order_by('lambda sr: (sr.money_transaction_ref.date, sr.creation_time)') %}
                  {% set asd = sr_amounts.append(sr.amount) %}
                  {% set remaining_amount=p.amount-sr_amounts | sum() %}
                  <tr>
                    <td title='{% if sr.money_transaction_ref.creation_type == MoneyTransaction.CREATION_TYPE.BY_MANUEL %}Manuel{% elif sr.money_transaction_ref.creation_type == MoneyTransaction.CREATION_TYPE.BY_BANK_TRANSACTION %}Banka işlemi{% endif %}'>{{ sr.money_transaction_ref.date.strftime("%Y-%m-%d") }}</td>
                    <td>{{ sr.money_transaction_ref.amount }} ₺</td>
                    <td title='{% if sr.is_auto %}Otomatik{% else %}Manuel{% endif %}'>{{ sr.creation_time.strftime("%Y-%m-%d") }}</td>
                    <td>{{ sr.amount }} ₺</td>
                    <td>{{ remaining_amount }} ₺</td>
                  </tr>
                {% endfor %}
              </table>
            </div>
          {% endif %}
        `,
        "detail": "{{ detail }}",
        "action":`
          <tr>
            {% if isinstance(p, Contribution) %}
              <td>{{ macros.button(url=url_for("transaction_page_bp.remove_contribution_by_manager_page", sandik_id=g.sandik.id, contribution_id=p.id), icon='fa fa-trash', type='danger', size='xs', title='İşlemi sil', confirm_msg='Aidatı silmek üzeresiniz. Bu işlem geri alınamaz. Silme işlemine devam etmek istiyor musunuz?') }}</td>
            {% endif %}
          </tr>
        `
      },
    {% endfor %}
    ]
  });

  $('#due-and-unpaid-payments-table').footable({
    "toggleColumn": "first",
    "paging": {
      "enabled": true,
      "size": 50
    },
    "filtering": {
      "enabled": true,
      "delay": 1,
      "dropdownTitle": "Şu sütunlarda ara:"
    },
    "sorting": {
      "enabled": true
    },
		"columns": [
			{ "name": "id", "title": "#", "breakpoints": "xs sm"},
			{ "name": "term", "title": "Tarih" },
			{ "name": "name_surname", "title": "İsim Soyisim" },
			{ "name": "transaction_type", "title": "İşlem türü", "breakpoints": "xs", },
			{ "name": "amount", "title": "Miktar", },
			{ "name": "remaining_amount", "title": "Ödenmemiş miktar", },
			{ "name": "is_fully_paid", "title": "Ödenme durumu", "breakpoints": "xs sm md", },
			{ "name": "detail", "title": "Detay", "breakpoints": "xs sm md", },
			{ "name": "sub_receipts", "title": "", "breakpoints": "xs sm md lg", },
			{ "name": "action", "title": "", "breakpoints": "xs sm md", },
		],
		"rows": [
    {% for p in g.due_and_unpaid_payments %}
      {% if isinstance(p, Contribution) %}
        {% set id_prefix='c' %}
        {% set transaction_type='Aidat' %}
        {% set detail='' %}
      {% elif isinstance(p, Installment) %}
        {% set id_prefix='i' %}
        {% set transaction_type='Taksit' %}
        {% set detail='Borç: #'+p.debt_ref.id|string %}
      {% else %}
        {% set id_prefix='UNKNOWN' %}
        {% set transaction_type='UNKNOWN' %}
        {% set detail='' %}
      {% endif %}
      {
        "id": `<span title='ID: {{ id_prefix }}-{{ p.id }}'>{{ loop.revindex }}</span>`,
        "term": "{{ p.term }}",
        "name_surname": "{{ p.member_ref.web_user_ref.name_surname }} - {{ p.share_ref.share_order_of_member }}",
        "transaction_type": `{{ transaction_type }}`,
        "amount": "{{ p.amount }} ₺",
        "remaining_amount": `<span class="{% if p.is_fully_paid %}text-success{% else %}text-danger{% endif %}">{{ p.get_unpaid_amount() }} ₺</span>`,
        "is_fully_paid": `{% if p.is_fully_paid %}<span class="text-success">Ödendi</span>{% elif p.get_paid_amount()>0 %}<span class="text-danger">Eksik</span>{% else %}<span class="text-danger">Ödenmedi</span>{% endif %}`,
        "sub_receipts": `
          {% if p.sub_receipts_set.count() == 0 %}
          İşlem yok
          {% else %}
            <div class="table table-responsive">
              <table class="table table-striped table-bordered" id="sub-receipts-of-{{ id_prefix }}{{ p.id }}-table">
                <tr>
                  <th colspan=2 class='text-center'>Para girişi</th>
                  <th colspan=3 class='text-center'>İlişkilendirme</th>
                </tr>
                <tr>
                  <th>Tarih</th>
                  <th>Miktar</th>
                  <th>Tarih</th>
                  <th>Miktar</th>
                  <th>Kalan Miktar</th>
                </tr>
                {% set sr_amounts = [] %}
                {% for sr in p.sub_receipts_set.order_by('lambda sr: (sr.money_transaction_ref.date, sr.creation_time)') %}
                  {% set asd = sr_amounts.append(sr.amount) %}
                  {% set remaining_amount=p.amount-sr_amounts | sum() %}
                  <tr>
                    <td title='{% if sr.money_transaction_ref.creation_type == MoneyTransaction.CREATION_TYPE.BY_MANUEL %}Manuel{% elif sr.money_transaction_ref.creation_type == MoneyTransaction.CREATION_TYPE.BY_BANK_TRANSACTION %}Banka işlemi{% endif %}'>{{ sr.money_transaction_ref.date.strftime("%Y-%m-%d") }}</td>
                    <td>{{ sr.money_transaction_ref.amount }} ₺</td>
                    <td title='{% if sr.is_auto %}Otomatik{% else %}Manuel{% endif %}'>{{ sr.creation_time.strftime("%Y-%m-%d") }}</td>
                    <td>{{ sr.amount }} ₺</td>
                    <td>{{ remaining_amount }} ₺</td>
                  </tr>
                {% endfor %}
              </table>
            </div>
          {% endif %}
        `,
        "detail": "{{ detail }}",
        "action":`
          <tr>
            {% if isinstance(p, Contribution) %}
              <td>{{ macros.button(url=url_for("transaction_page_bp.remove_contribution_by_manager_page", sandik_id=g.sandik.id, contribution_id=p.id), icon='fa fa-trash', type='danger', size='xs', title='İşlemi sil', confirm_msg='Aidatı silmek üzeresiniz. Bu işlem geri alınamaz. Silme işlemine devam etmek istiyor musunuz?') }}</td>
            {% endif %}
          </tr>
        `
      },
    {% endfor %}
    ]
	});

});
</script>
{% endblock %}

{% block content_block %}
  <div class="bg-light lter b-b wrapper-md">
    <h1 class="m-n font-thin h3">{{ page_info.title }}</h1>
  </div>
  <div class="wrapper-md">
    <div class="panel panel-default">
      <div class="panel-heading">
        Vadesi gelmiş ve ödenmemiş ödemeler
        <span class="pull-right">
          {% if g.type == "member" %}
            {{ macros.button(url=url_for("transaction_page_bp.pay_unpaid_payments_from_untreated_amount_of_member_page", sandik_id=g.sandik.id), icon='fa fa-repeat', type='default', size='sm', title='Yenile') }}
          {% elif g.type == "management" %}
            {{ macros.button(url=url_for("transaction_page_bp.pay_unpaid_payments_from_untreated_amount_of_sandik_page", sandik_id=g.sandik.id), icon='fa fa-repeat', type='default', size='sm', title='Yenile') }}
          {% endif %}
        </span>
      </div>
      <div class="table table-responsive">
        <table class="table table-striped " id="due-and-unpaid-payments-table"></table>
      </div>
    </div>
    <div class="panel panel-default">
      <div class="panel-heading">
        Bütün ödemeler
        <span class="pull-right">
          {# {{ url_for('transaction_page_bp.add_sandik_transaction_by_manager_page', sandik_id=g.sandik.id) }} #}
          <a href="#" class="btn btn-xs btn-primary">
            <i class="fa fa-plus"></i>
          </a>
        </span>
      </div>
      <div class="table table-responsive">
        <table class="table table-striped " id="all-payments-table"></table>
      </div>
    </div>
  </div>
{% endblock %}